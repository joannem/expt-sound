<html>
<head>
	<title>Waveform</title>
	<link rel="stylesheet" type="text/css" href="waveform.css">
</head>
<body>
	<br><br>
	<div id="waveform">
		<canvas class="waveform-canvas" id="waveform-canvas-left"></canvas>
		<br><br>
		<canvas class="waveform-canvas" id="waveform-canvas-right"></canvas>

		<!-- try drawing with D3 here -->
	</div>

	<br>

	<div id="drop">
		<h2>drag and drop here!</h2>
	</div>

	<div id="controls">
		<button class="play-pause-btn">play</button>
	</div>

</body>

<script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="js/dragAndDropFileLoader.js"></script>
<script type="text/javascript" src="js/playback.js"></script>

<script type="text/javascript">
	var audioCtx = new AudioContext();
	var soundData = null;
	var windowWidth = $(window).width();
	var canvasHeight = 150;

	function setUpVisualisations() {
		drawWaveform(soundData);
	}

	function drawWaveform(buffer) {
		var pcmL = buffer.getChannelData(0);
		var pcmR = buffer.getChannelData(1);
		
		console.log("buffer len: " + buffer.length);
		var bufferLen = buffer.length;

		
		var canvasLeft = document.getElementById('waveform-canvas-left');
		var canvasRight = document.getElementById('waveform-canvas-right');

		var canvasLeftCtx = $("#waveform-canvas-left").get()[0].getContext("2d");
		var canvasRightCtx = $("#waveform-canvas-right").get()[0].getContext("2d");

		canvasLeft.setAttribute('width', windowWidth);
		canvasRight.setAttribute('width', windowWidth);
		canvasLeft.setAttribute('height', canvasHeight);
		canvasRight.setAttribute('height', canvasHeight);

		canvasLeftCtx.fillRect(0, 0, windowWidth, canvasHeight);
		canvasRightCtx.fillRect(0, 0, windowWidth, canvasHeight);

		canvasLeftCtx.fillStyle = '#0FF000';
		canvasRightCtx.fillStyle = '#0FF000';
		
		var jump = Math.floor(bufferLen / windowWidth);
		console.log('jump: ' + jump);

		var maxL = 0;
		var maxR = 0;
		
		for (var i = 0; i < bufferLen; i = i + jump) {
			maxL = Math.abs(pcmL[i]) > maxL ? Math.abs(pcmL[i]) : maxL;
			maxR = Math.abs(pcmR[i]) > maxR ? Math.abs(pcmR[i]) : maxR;
		}

		console.log("maxL: " + maxL);
		console.log("maxR: " + maxR);

		var x = 0;
		var heightL = 0;
		var heightR = 0;

		for(var i = 0; i < bufferLen; i = i + jump) {
			// -5 scale to leave a gap between waveform and border of canvas
			heightL = pcmL[i] / maxL * ((canvasHeight / 2) - 5);
			heightR = pcmR[i] / maxR * ((canvasHeight / 2) - 5);
			
			if (heightL < 0) {
				canvasLeftCtx.fillRect(x, (canvasHeight / 2), 1, Math.abs(heightL));
			} else {
				canvasLeftCtx.fillRect(x, (canvasHeight / 2) - heightL, 1, Math.abs(heightL));
			}

			if (heightR < 0) {
				canvasRightCtx.fillRect(x, (canvasHeight / 2), 1, Math.abs(heightR));
			} else {
				canvasRightCtx.fillRect(x, (canvasHeight / 2) - heightR, 1, Math.abs(heightR));
			}

			x++;
		}
	}

</script>
</html>